<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lux's RPG Game</title>
    <style>
        :root { --bg: #0a0a0c; --panel: #16161a; --text: #e1e1e6; --hp: #ff4757; --mana: #3742fa; --sanity: #a55eea; --gold: #eccc68; --unlocked: #2ed573; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 20px; }
        .stats-row { display: flex; gap: 15px; margin-bottom: 25px; }
        .stat-box { flex: 1; background: #000; padding: 15px; border-radius: 12px; border-bottom: 4px solid #2f3542; }
        .progress-bg { background: #1e1e24; height: 14px; border-radius: 7px; margin-top: 10px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; transition: width 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .hp-label { position: absolute; width: 100%; text-align: center; font-size: 11px; font-weight: 800; top: 0; color: white; text-shadow: 1px 1px 2px black; }
        #log { height: 200px; background: #050505; overflow-y: auto; padding: 15px; font-family: 'Fira Code', monospace; border-radius: 8px; border: 1px solid #2f3542; margin-bottom: 25px; font-size: 14px; }
        .tree-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; }
        .node { padding: 15px; background: #2f3542; border-radius: 10px; text-align: center; border: 2px solid transparent; cursor: pointer; opacity: 0.5; transition: 0.2s; }
        .node.available { border-color: var(--mana); opacity: 1; }
        .node.purchased { background: #1b2e1b; border-color: var(--unlocked); color: var(--unlocked); opacity: 1; cursor: default; }
        .shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .shop-item { background: #1e1e24; padding: 20px; border-radius: 12px; border: 1px solid var(--gold); text-align: center; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button { padding: 15px; cursor: pointer; border: none; border-radius: 8px; background: #2f3542; color: white; font-weight: 700; transition: 0.3s; }
        button:hover:not(:disabled) { background: #57606f; transform: translateY(-2px); }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        .hidden { display: none !important; }
        .san-warn { color: var(--sanity); font-weight: bold; }
        .save-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
        }
        .export-btn {
            padding: 6px 12px;
            font-size: 12px;
            background: #444;
            border: 1px solid #666;
        }
        .import-btn {
            padding: 6px 12px;
            font-size: 12px;
            background: #444;
            border: 1px solid #666;
        }
        #tooltip b { color: var(--gold); }
        #tooltip span { display: block; margin-top: 4px; border-top: 1px solid #444; padding-top: 4px; font-size: 11px; color: #aaa; }

        /* Hidden file input for the Import functionality */
        #import-input { display: none; }

#debugging-panel { 
    position: fixed; 
    top: 15px;      /* Slight offset from the very edge */
    left: 15px; 
    background: var(--panel); 
    border: 2px solid var(--mana); 
    padding: 20px; 
    border-radius: 15px; 
    z-index: 9999; 
    box-shadow: 0 0 100px rgba(0,0,0,0.9); 
    width: 350px; 
}

/* Hidden Trigger positioned top-left */
.ghost-trigger { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 20px;    /* Slightly larger target for top-left */
    height: 20px; 
    background: transparent; 
    z-index: 10000; 
    cursor: default; 
}
#game-wrapper {
    display: flex;          
    justify-content: center; 
    align-items: flex-start; 
    gap: 30px;              
    width: 100%;
    margin-top: 20px;
}

#game-container {
    width: 850px;
    background: var(--panel);
    padding: 30px;
    border-radius: 20px;
    border: 2px solid var(--border); /* Thicker, lighter border */
    box-shadow: 0 0 40px rgba(0, 0, 0, 0.8), 0 0 20px rgba(55, 66, 250, 0.1); /* Subtle blue glow */
    position: relative;
    flex-shrink: 0;
}

#stat-sidebar {
    width: 280px;
    background: var(--panel); /* Same lighter gray as game-container */
    padding: 25px;
    border-radius: 20px;
    border: 2px solid var(--border);
    box-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
    flex-shrink: 0;
}

.stat-entry {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    border-bottom: 1px dashed #2f3542;
    padding-bottom: 5px;
}


.stat-entry b { color: var(--gold); }
.stat-label { color: #a4b0be; }


    </style>
</head>
<body>
<div class="save-controls">
    <button class="export-btn" onclick="exportSave()">Export .urpg</button>

    <label for="import-input" class="import-btn" style="cursor:pointer; display:inline-block;">Import .urpg</label>
    <input type="file" id="import-input" accept=".urpg" onchange="importSave(event)">
</div>
<div id="tooltip" style="position: fixed; display: none; background: rgba(0,0,0,0.9); color: white; padding: 10px; border: 1px solid var(--mana); border-radius: 8px; font-size: 13px; z-index: 10000; pointer-events: none; line-height: 1.4;"></div>

<div id="game-wrapper">

    <div id="game-container">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0">Day <span id="day-txt">1</span></h2>
            <div style="font-size: 1.1em;">
                Gold: <span id="gold-txt" style="color:var(--gold)">0</span> | 
                SP: <span id="sp-txt" style="color:var(--unlocked)">0</span>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-box" style="border-color:var(--hp)">Life: <span id="hp-val" style="display: none;">100/100</span><div class="progress-bg"><div id="hp-bar" class="progress-fill" style="background:var(--hp); width:100%"></div></div></div>
            <div class="stat-box" style="border-color:var(--mana)">Mana: <span id="mp-val" style="display: none;">50/50</span><div class="progress-bg"><div id="mp-bar" class="progress-fill" style="background:var(--mana); width:100%"></div></div></div>
            <div class="stat-box" style="border-color:var(--sanity)">Sanity: <span id="sn-val" style="display: none;">100/100</span><div class="progress-bg"><div id="sn-bar" class="progress-fill" style="background:var(--sanity); width:100%"></div></div></div>
            <div class="stat-box" style="border-color:lime">
                LV <span id="lv-txt">1</span> | EXP: <span id="exp-val">0/100</span>
                <div class="progress-bg"><div id="exp-bar" class="progress-fill" style="background:lime; width:0%"></div></div>
            </div>
        </div>

        <div id="log">Welcome to your standard RPG.</div>

        <div id="shop-view" class="hidden">
            <h3>Wandering Merchant</h3>
            <div id="shop-shelf" class="shop-grid"></div>
            <button style="width:100%" onclick="exitEvent()">Continue</button>
        </div>

        <div id="tree-view" class="hidden">
            <h3>Spell Tree</h3>
            <div class="tree-grid" id="tree-nodes"></div>
            <button style="width:100%; margin-top:20px;" onclick="exitEvent()">Close Spell Tree</button>
        </div>
        <div id="combat-view" class="hidden">
            <div style="background:#1e1e24; padding:25px; border-radius:15px; margin-bottom:20px; border: 1px solid #2f3542; text-align:center;">
                <h3 id="e-name" style="margin:0; text-transform:uppercase; letter-spacing:2px;">Target</h3>
                <div class="progress-bg" style="width:100%; max-width:400px; height:24px; margin:15px auto;">
                    <div id="e-hp-bar" class="progress-fill" style="background:var(--hp); width:100%"></div>
                    <div id="e-hp-txt" class="hp-label">HP: -- / --</div>
                </div>
                <div id="e-traits" style="font-size:0.8em; color:#a4b0be"></div>
            </div>
            <div style="margin-bottom: 15px;">
                <input type="text" id="action-search" placeholder="Search spells..." oninput="renderCombatButtons()" style="width: 100%; padding: 10px; background: #000; border: 1px solid var(--mana); color: white; border-radius: 8px; box-sizing: border-box;">
            </div>
            <div class="controls" id="combat-btns"></div>
        </div>

        <div id="main-controls" class="controls">
            <button onclick="nextDay()">Explore Onward</button>
            <button onclick="openTree()">Study Spells</button>
        </div>

    </div> 
    <div id="stat-sidebar">
        <h3 style="margin-top:0; color:var(--mana); border-bottom: 2px solid var(--mana); padding-bottom: 10px;">Character Stats</h3>
        <div class="stat-entry"><span class="stat-label">Current Max Life:</span> <b id="side-mhp">100</b></div>
        <div class="stat-entry"><span class="stat-label">Current Life:</span> <b id="side-hp">100</b></div>
        <div style="margin: 15px 0; border-top: 1px solid #2f3542;"></div>
        <div class="stat-entry"><span class="stat-label">Current Max Mana:</span> <b id="side-mmp">50</b></div>
        <div class="stat-entry"><span class="stat-label">Current Mana:</span> <b id="side-mp">50</b></div>
        <div class="stat-entry"><span class="stat-label">Current Mana Reduction:</span> <b id="side-red">0%</b></div>
        <div style="margin: 15px 0; border-top: 1px solid #2f3542;"></div>
        <div class="stat-entry"><span class="stat-label">Current Max Sanity:</span> <b id="side-msn">100</b></div>
        <div class="stat-entry"><span class="stat-label">Current Sanity:</span> <b id="side-sn">100</b></div>
        <div style="margin: 15px 0; border-top: 1px solid #2f3542;"></div>
        <div class="stat-entry"><span class="stat-label">Current Level:</span> <b id="side-lv">1</b></div>
        <div class="stat-entry"><span class="stat-label">Current EXP:</span> <b id="side-exp">0</b></div>
        <div class="stat-entry"><span class="stat-label">EXP to Next LV:</span><b id="side-next-exp">100</b></div>
        <div style="margin: 15px 0; border-top: 1px solid #2f3542;"></div>
        <div class="stat-entry"><span class="stat-label">Current Gold:</span> <b id="side-gold">0</b></div>
        <div class="stat-entry"><span class="stat-label">Skill Points Available:</span> <b id="side-sp">0</b></div>
        <div style="margin: 15px 0; border-top: 1px solid #2f3542;"></div>
        <div class="stat-entry"><span class="stat-label">Total Kills:</span> <b id="side-kills">0</b></div>
        <div class="stat-entry"><span class="stat-label">Damage multiplier:</span> <b id="side-dmgmult">100%</b></div>
    </div>

</div>

<!-- Ghost Admin Trigger & Panel -->
<div id="debugging-panel" class="hidden">
    <h3 style="margin-top:0; color:var(--mana); font-family: 'Fira Code', monospace; font-size: 14px;">Lux's Game Master Console >_</h3>
    <div id="console-output" style="height:100px; overflow-y:auto; background:#000; font-family:'Fira Code', monospace; font-size:12px; padding:10px; margin-bottom:10px; border:1px solid #333; color:#2ed573;">
        System ready...
    </div>
    <input type="text" id="console-input" placeholder="Enter command..." 
           style="width:100%; background:#000; border:1px solid var(--mana); color:white; padding:10px; box-sizing:border-box; font-family:'Fira Code', monospace;">
    <p style="font-size:10px; color:#666; margin-top:5px;">Type /help for commands. Press ESC to close.</p>
</div>
<div class="ghost-trigger" onclick="toggleAdmin()"></div>

<script>
    let nextEnemyOverride = null; // Stores the name of the forced enemy
    let p = { 
        v: 8, // Version Number
        hp: 100, // HP
        mhp: 100, // Max HP
        mp: 50, // Mana
        mmp: 50, // Max Mana
        sn: 100, // Sanity
        msn: 100, // Max Sanity
        gold: 50, // Current Gold at start
        exp: 0, // Current EXP at start
        lv: 1, // LV
        sp: 0, // Skill points
        day: 1, // Current Day at start
        skills: ['strike'], // Skills at start
        manaReduction: 0,  // Mana Reduction (0 is 0% reduction and base)
        kills: 0, // Total amount of kills
        dmgmult: 1 // Damage Multiplier
        
    };
    let enemy = null;

    const masterShop = [
        { 
        id: 'healthrefill', 
        name: 'Health Vial', 
        get cost() { return Math.floor(20 * Math.pow(1.1, p.lv - 1)); }, 
        run: () => { p.hp = p.mhp; return "Vitality restored!"; } 
        },

        { 
        id: 'manarefill', 
        name: 'Mana Well', 
        get cost() { return Math.floor(20 * Math.pow(1.1, p.lv - 1)); }, 
        run: () => { p.mp = p.mmp; return "Mana restored!"; } 
        },

        { 
        id: 'sanityrefill', 
        name: 'Clarity Tonic', 
        get cost() { return Math.floor(20 * Math.pow(1.1, p.lv - 1)); }, 
        run: () => { p.sn = p.msn; return "Sanity restored!"; } 
        },

        { 
        id: 'healthincrease1', 
        name: 'Dragon Heart', 
            get cost() { return Math.floor(60 * Math.pow(1.2, p.lv - 1)); }, 
            run: () => {
                let gain = Math.floor(30 + (p.mhp * 0.1));
                p.mhp += gain; 
                p.hp += gain; 
                return `Max HP increased by ${formatNumber(gain)}`; 
            } 
        },

        { 
        id: 'manaincrease1', 
        name: 'Eldritch Orb', 
            get cost() { return Math.floor(60 * Math.pow(1.2, p.lv - 1)); }, 
            run: () => { 
                let gain = Math.floor(30 + (p.mmp * 0.1));
                p.mmp += gain; 
                p.mp += gain; 
                return `Max Mana increased by ${formatNumber(gain)}`; 
            } 
        },

        { 
        id: 'sanityincrease1', 
        name: 'Pure Insight', 
            get cost() { return Math.floor(60 * Math.pow(1.2, p.lv - 1)); }, 
            run: () => { 
                let gain = Math.floor(30 + (p.msn * 0.1));
                p.msn += gain; 
                p.sn += gain; 
                return `Max Sanity increased by ${formatNumber(gain)}`; 
            } 
        },
        
        { 
        id: 'fullrefill', 
        name: 'Holy Grail', 
        get cost() { return Math.floor(70 * Math.pow(1.1, p.lv - 1)); }, 
        run: () => { 
        p.hp = p.mhp; 
        p.mp = p.mmp; 
        p.sn = p.msn; 
        return "HP, Mana, and Sanity restored"; 
            }
        },

        { 
        id: 'treasuremap', 
        name: 'Treasure Map', 
        get cost() { return Math.floor(40 * Math.pow(1.15, p.lv - 1)); }, 
            run: () => { 
                let gain = Math.floor(100 * Math.pow(1.25, p.lv - 1));
                p.gold += gain; 
                if (Math.random() < 0.05) {
                    if (p.gold < 10000) {
                        log(`Lux: You know... you're different. Most humans I've seen are greedy. You are different somehow. Or maybe you're just the same as the rest.`,"#3c23a8");
                    } else {
                        log(`Lux: You know... I never get why humans are so... greedy in the first place. Their lives are short anyway. Why would they need that much gold?`,"#3c23a8");
                    }
                }
                return `Found a hidden cache of ${formatNumber(gain)} gold!`; 
            } 
        },

        { 
        id: 'expscroll', 
        name: 'Knowledge Scroll', 
        get cost() { return Math.floor(40 * Math.pow(1.15, p.lv - 1)); }, 
            run: () => { 
                let gain = Math.floor(100 * Math.pow(1.25, p.lv - 1));
                addExperience(gain)
                if (Math.random() < 0.05) {
                    log(`Lux: Try all you want. You'll never be as knowledged as me =)`,"#3c23a8");
                }
                return `Learned new knowledge. (+${formatNumber(gain)} EXP)`; 
            } 
        },

        { 
            id: 'manastabilizer', 
            name: 'Mana Stabilizer', 
            get cost() { return Math.floor(150 * Math.pow(1.3, p.lv - 1)); }, 
            run: () => { 
                // Cap the value at 1.0 (100%)
                p.manaReduction = Math.min(1, p.manaReduction + 0.01); 

                if (p.manaReduction >= 1) {
                    return "Magic Efficiency perfected! Mana costs are now at their base minimum.";
                }
                return `Magic Efficiency increased! Mana Costs reduced by an additional 1%.`; 
            } 
        },
        { 
            id: 'dmgmult', 
            name: 'Damage Multiplier', 
            get cost() { return Math.floor(300 * Math.pow(1.3, p.lv - 1)); }, 
            run: () => { 
                p.dmgmult += 0.05; 
                if (Math.random() < 0.05) {
                    log(`Lux: Interesting... I see you've learned how to hurt better... I wonder how that...`, "#3c23a8")
                    setTimeout(() => {
                        log(`Lux: ...feels?`,"#ff0000")
                    }, 500); // 500ms = 0.5 seconds
                }
                return `Damage Multiplier increased! Mana Damage increased by an additional 5%.`;
            } 
        }
    ];

    const skillTree = {
        strike: {
            name: "Strike",
            cost: 0,
            parent: null,
            unlocked: true,
            get dmg() {
                return Math.floor((12*(p.dmgmult+1)))
            }

        },
        fireball: {
            name: "Fireball", 
            cost: 1, 
            parent: 'strike', 
            unlocked: false, 
            mp: 15, 
            get dmg() { 
                return Math.floor((((p.lv*0.5)*22)+22)*(p.dmgmult+1)); 
            },
            get burn() {
                return (p.lv*2);
            }
        },
        thunderbolt: {
            name: "Thunderbolt", 
            cost: 2, 
            parent: 'fireball', 
            unlocked: false, 
            mp: 45, 
            get dmg() { 
                return Math.floor((((p.lv*0.5)*70)+70)*(p.dmgmult+1)); 
            }
        },
        fingerofdeath: {
            name: "Finger of Death", 
            cost: 3, 
            parent: 'thunderbolt', 
            unlocked: false, 
            mp: 100, 
            get dmg() { 
                return Math.floor(((p.lv*250)+250)*(p.dmgmult+1)); 
            }
        },
        siphonray: {
            name: "Siphon Ray", 
            cost: 4, 
            parent: 'fingerofdeath', 
            unlocked: false, 
            mp: 100, 
            get dmg() {
                return Math.floor(((p.lv*100)+100)); 
            },
            get heal() { 
                return Math.floor(((p.lv*100)+100)*(p.dmgmult+1)); 
            }
        },
        eldritchblast: {
            name: "Eldritch Blast", 
            cost: 4, 
            parent: 'siphonray', 
            unlocked: false, 
            mp: 100, 
            get dmg() {
                return Math.floor(((p.lv*400)+400)*(p.dmgmult+1)); 
            }
        },
        iceshock: {
            name: "Iceshock", 
            cost: 5, 
            parent: 'eldritchblast', 
            unlocked: false, 
            mp: 10000, 
            get dmg() { 
                return Math.floor((((p.lv - 10) * 30) + 90)*(p.dmgmult+1)); 
            },
        },
        snowgrave: {
            name: "Snowgrave", 
            cost: 6, 
            parent: 'iceshock', 
            unlocked: false, 
            mp: 20000, 
            get dmg() { 
                return Math.floor(((p.lv*40)+600)*(p.dmgmult+1)); 
            },
            get san() {
                return Math.floor(((p.sn-(p.sn/2))*(-1)))
            }
        },
        heal: {
            name: "Heal", 
            cost: 1, 
            parent: 'strike', 
            unlocked: false, 
            mp: 20000, 
            get heal() { 
                return Math.floor(((35*p.lv)+10)); 
            }
        },
        mindshield: {
            name: "Mind Shield", 
            cost: 2, 
            parent: 'heal', 
            unlocked: false, 
            mp: 5000, 
            get san() { 
                return Math.floor(((p.mmp*5)+5)); 
            },
        },
        dualheal: {
            name: "Dual Heal", 
            cost: 3, 
            parent: 'mindshield', 
            unlocked: false, 
            mp: 5000, 
            get heal() { 
                return Math.floor(((p.lv*1000)+2000)); 
            },
            get san() {
                return Math.floor(((p.lv*100)+850))
            }
        },
        healprayer: {
            name: "Heal Prayer", 
            cost: 5, 
            parent: 'dualheal', 
            unlocked: false, 
            mp: 5000, 
            get heal() { 
                return Math.floor(((p.mmp*5)+5)); 
            },
        },
        ralseidualheal: {
            name: "Ralsei's Signature Dual Heal", 
            cost: 10, 
            parent: 'healprayer', 
            unlocked: false, 
            mp: 10000, 
            get heal() { 
                return Math.floor(((p.mmp*5.5)+p.msn)); 
            },
            get san() {
                return Math.floor(((p.msn*5.5)+p.mmp));
            }
        }
    };
    const enemies = [
        /*
        Vars to use for enemies:
        name = the name of the enemy
        hp = current hp
        mhp = max hp of the enemy
        atk = dmg dealt by enemy
        san = amount of sanity drain enemy deals
        exp = amount of exp recived when enemy is killed
        gold = amount of gold recived when enemy is killed
        lifesteal = amoutn of hp enemy heals for each round (must be equal to or higher the dmg stat)
        burnImmune = true/false, makes enemy either immune to burn dmg or not
        burnResist = 0-1, 0.5 = half burn dmg
        burnVuln = any number higher then 1, 1.5 = 150% burn damage
        burnReflect = amount of burn damage reflected to player
        */
        
        /*
        Run Enders
        */
        {
            name: "Lux",
            weight: 1,
            get hp() {
                return this.mhp;
            },
            get mhp() {
                return (1000000000)*p.lv;
            },
            get atk() {
                return ((50000)*p.lv)*p.dmgmult
            },
            get san() {
                return (50000)*p.lv
            },
            get exp() {
                return (((100000)*p.lv)*-1)
            },
            get gold() {
                return (((100000)*p.lv)*-1)
            },
            get lifesteal() {
                return (10000)*p.lv
            },
            burnImmune: true,
            canSpawn: () => p.lv >= 100 && p.skills.includes('snowgrave') || p.skills.includes('ralseidualheal'),
            trait: "The god of this forsaken realm",
            specialMsg: "Lux: Hello there, and welcome. To my realm of nightmares =)"
        },
        {
            name: "Kitsune",
            weight: 2,
            get hp() {
                return this.mhp
            },
            get mhp() {
                return ((1000000)*(p.lv/1.25))
            },
            get atk() {
                return ((5000)*(p.lv/1.25))
            },
            get san() {
                return ((5000)*(p.lv/1.25))
            },
            get exp() {
                return (((10000)*(p.lv/1.25))*-1)
            },
            get gold() {
                return (((10000)*(p.lv/1.25))*-1)
            },
            get lifesteal() {
                return ((1000)*(p.lv/1.25))
            },
            burnResist: 0.9,
            burnReflect: 1,
            canSpawn: () => p.lv >= 50 && p.skills.includes('eldritchblast'),
            trait: "Lux's Run Ender Minion",
            specialMsg: "Kitsune: If you kill me, my god will kill you."
        },
        /*
        World Bosses
        */
        {
            name: "Azmodan",
            weight: 5,
            get hp() {
                return this.mhp
            },
            get mhp() {
                return ((10000)*(p.lv/2))
            },
            get atk() {
                return ((240)*(p.lv/2))
            },
            get san() {
                return ((50)*(p.lv/2))
            },
            get exp() {
                return ((1200)*(p.lv/2))
            },
            get gold() {
                return ((32000)*(p.lv/2))
            },
            get lifesteal() {
                return 1000*p.lv
            },
            canSpawn: () => p.lv >= 30 && p.skills.includes('eldritchblast'),
            trait: "World boss",
            specialMsg: "Azmodan: This world will burn by Lux's hand and I will make sure it does."
        },
        /*
        Bosses
        */
        {
            name: "Obsidian Golem",
            weight: 10,
            get hp() {
                return this.mhp
            },
            get mhp() {
                return 1500+(p.lv*100)
            },
            atk: 160, san: 20,
            exp: 800, gold: 640,
            lifesteal: 0,
            canSpawn: () => p.lv >= 20,
            trait: "Boss"
        },
        {
            name: "Duriel",
            weight: 10,
            get hp() {
                return this.mhp
            },
            get mhp() {
                return 1300+(p.lv*100)
            },
            atk: 150, san: 30,
            exp: 800, gold: 640,
            lifesteal: 0,
            canSpawn: () => p.lv >= 20,
            trait: "Boss"
        },
        {
            name: "Will o' Wisp",
            weight: 10,
            get hp() {
                return this.mhp
            },
            get mhp() {
                return 2500+(p.lv*100)
            },
            atk: 120, san: 60,
            exp: 800, gold: 640,
            lifesteal: 0,
            canSpawn: () => p.lv >= 20,
            trait: "Boss",
            specialMsg: `Ever heard of "Lux"? Heard he's quite a nice guy!`
        },
        /*
        Mini-Bosses
        */
        {
            name: "Diamond Golem",
            weight: 20,
            hp: 600, mhp: 600,
            atk: 80, san: 10,
            exp: 400, gold: 320,
            lifesteal: 0,
            canSpawn: () => p.lv >= 15,
            trait: "Mini-Boss"
        },
        /*
        Elementals
        */
        {
            name: "Fire Elemental",
            weight: 20,
            hp: 600, mhp: 600,
            atk: 80, san: 10,
            exp: 400, gold: 320,
            lifesteal: 0,
            burnImmune: true,
            canSpawn: () => p.lv >= 15,
            trait: "Elemental"
        },
        {
            name: "Air Elemental",
            weight: 20,
            hp: 600, mhp: 600,
            atk: 80, san: 10,
            exp: 400, gold: 320,
            lifesteal: 0,
            burnResist: 0.5,
            canSpawn: () => p.lv >= 15,
            trait: "Elemental"
        },
        {
            name: "Water Elemental",
            weight: 20,
            hp: 600, mhp: 600,
            atk: 80, san: 10,
            exp: 400, gold: 320,
            lifesteal: 0,
            burnResist: 0.2,
            canSpawn: () => p.lv >= 15,
            trait: "Elemental"
        },
        {
            name: "Earth Elemental",
            weight: 20,
            hp: 600, mhp: 600,
            atk: 80, san: 10,
            exp: 400, gold: 320,
            lifesteal: 0,
            canSpawn: () => p.lv >= 15,
            trait: "Elemental"
        },
        {
            name: "Ice Elemental",
            weight: 20,
            hp: 600, mhp: 600,
            atk: 80, san: 10,
            exp: 400, gold: 320,
            lifesteal: 0,
            burnVuln: 1.5,
            canSpawn: () => p.lv >= 15,
            trait: "Elemental"
        },
        /*
        Lifesteal Enemies
        */
        {
            name: "Blood Bat",
            weight: 40,
            hp: 50, mhp: 50,
            atk: 11, san: 5,
            exp: 30, gold: 25,
            lifesteal: 10,
            canSpawn: () => p.skills.includes('fire'),
            trait: "Regenerates 10 HP per turn"
        },
        {
            name: "Vampire",
            weight: 30,
            hp: 150, mhp: 150,
            atk: 33, san: 15,
            exp: 90, gold: 75,
            lifesteal: 30,
            canSpawn: () => p.skills.includes('fire') && p.lv >= 30,
            trait: "Regenerates 30 HP per turn",
            specialMsg: "Vampire: Don't worry, it won't hurt."
        },
        {
            name: "Vampire Lord",
            weight: 12,
            hp: 450, mhp: 450,
            atk: 99, san: 45,
            exp: 270, gold: 225,
            lifesteal: 90,
            canSpawn: () => p.skills.includes('fire') && p.lv >= 40,
            trait: "Regenerates 90 HP per turn",
            specialMsg: "Vampire Lord: Okay it might hurt a little bit..."
        },
        {
            name: "Vampire King",
            weight: 6,
            hp: 900, mhp: 900,
            atk: 198, san: 90,
            exp: 540, gold: 450,
            lifesteal: 180,
            canSpawn: () => p.skills.includes('fire') && p.lv >= 50,
            trait: "Regenerates 180 HP per turn",
            specialMsg: "Vampire King: There is only one entity I fear. That entity being Lux."
        },
        /*
        Sanity Drain Enemies
        */
        {
            name: "Gloom Weaver",
            weight: 35,
            hp: 55, mhp: 55,
            atk: 10, san: 18,
            exp: 45, gold: 35,
            lifesteal: 0,
            canSpawn: () => true,
            trait: "Sanity Drainer",
            specialMsg: "Nightmare may stalk you..."
        },
        {
            name: "Void Stalker",
            weight: 25,
            hp: 90, mhp: 90,
            atk: 15, san: 25,
            exp: 60, gold: 50,
            lifesteal: 0,
            canSpawn: () => p.lv >= 5 || p.msn >= 150,
            trait: "Elite Sanity Predator",
            specialMsg: "...but Lux stalks us all."
        },
        /*
        Glass Cannons
        */
        {
            name: "Glass Cannon the I",
            weight: 3,
            hp: 12, mhp: 12,
            atk: 1000000000, san: 1000000000,
            exp: 10, gold: 5,
            lifesteal: 0,
            trait: "Glass Cannon",
            canSpawn: () => true,
            specialMsg: "Glass Cannon the I: Hello!"
        },
        {
            name: "Glass Cannon the II",
            weight: 2,
            hp: 24, mhp: 24,
            atk: 10000000000, san: 10000000000,
            exp: 20, gold: 10,
            lifesteal: 0,
            trait: "Glass Cannon",
            canSpawn: () => p.skills.includes('fire'),
            specialMsg: "Glass Cannon the II: Have you seen Glass Cannon the I yet? He made a bet with me yesterday and lost."
        },
        {
            name: "Glass Cannon the III",
            weight: 1,
            hp: 36, mhp: 36,
            atk: 100000000000, san: 100000000000,
            exp: 30, gold: 15,
            lifesteal: 0,
            trait: "Glass Cannon",
            canSpawn: () => p.skills.includes('fire') || p.lv >= 2,
            specialMsg: "Glass Cannon the III: Did you kill Glass Cannon the II yet? He owes me 20 gold from yesterday."
        },
        {
            name: "Glass Cannon the IV",
            weight: 1,
            hp: 48, mhp: 48,
            atk: 1000000000000, san: 1000000000000,
            exp: 40, gold: 20,
            lifesteal: 0,
            trait: "Glass Cannon",
            canSpawn: () => p.skills.includes('fire') || p.lv >= 6,
            specialMsg: "Glass Cannon the IV: Heard of my brother Glass Cannon the V? He's never afraid of anything. Well except one thing..."
        },
        {
            name: "Glass Cannon the V",
            weight: 1,
            hp: 60, mhp: 60,
            atk: 10000000000000, san: 10000000000000,
            exp: 50, gold: 25,
            lifesteal: 0,
            trait: "Glass Cannon",
            canSpawn: () => p.skills.includes('fire') || p.lv >= 10,
            specialMsg: "Glass Cannon the V: Haha, you finally made it... but Lux still laughs at us all."
        },
        /*
        Normal Enemies
        */
        {
            name: "Shadow Imp",
            weight: 60,
            hp: 45, mhp: 45,
            atk: 9, san: 0,
            exp: 20, gold: 15,
            lifesteal: 0,
            canSpawn: () => true,
            trait: "Normal enemy"
        },
        {
            name: "Armored Beetle",
            weight: 55,
            hp: 80, mhp: 80,
            atk: 6, san: 0,
            exp: 35, gold: 20,
            lifesteal: 0,
            canSpawn: () => true,
            trait: "High HP, however Low ATK"
        },
        {
            name: "Drow Elf",
            weight: 53,
            hp: 90, mhp: 90,
            atk: 25, san: 5,
            exp: 70, gold: 150,
            lifesteal: 0,
            canSpawn: () => p.skills.includes('thunderbolt'),
            trait: "Hates regular elves",
            specialMsg: "Drow Elf: We Drow Elves only bow to one god. That one being the creator of this realm."
        },
        {
            name: "Elf",
            weight: 59,
            hp: 80, mhp: 80,
            atk: 15, san: 0,
            exp: 35, gold: 70,
            lifesteal: 0,
            canSpawn: () => p.skills.includes('thunderbolt'),
            trait: "Hates Drow elves elves",
            specialMsg: `Elf: We find Drow Elves goofy in a way that they fear a so called "god". He certainly can't be real... right?`
        },
        {
            name: "Stone Golem",
            weight: 50,
            hp: 150, mhp: 150,
            atk: 20, san: 0,
            exp: 100, gold: 80,
            lifesteal: 0,
            canSpawn: () => p.lv >= 5,
            trait: "Slow Titan"
        },
        {
            name: "Iron Golem",
            weight: 40,
            hp: 300, mhp: 300,
            atk: 40, san: 5,
            exp: 200, gold: 160,
            lifesteal: 0,
            canSpawn: () => p.lv >= 7,
            trait: "Slow Titan"
        },
    ];
    function checkLuxKillLogs() {
    const kills = p.kills;

    if (kills === 1) {
        log(`Lux: Ah… one soul. How… quaint.`, "#3c23a8");

    } else if (kills === 10) {
        log(`Lux: Ten souls… growing bolder, are we?`, "#4625a6");

    } else if (kills === 100) {
        log(`Lux: Ah… I see you've killed 100 souls. How… diligent of you.`, "#5128a3");
        setTimeout(() => {
            log(`Lux: But remember… all of this… is still meaningless.`, "#7a2a7a");
        }, 1000);
        setTimeout(() => {
            log(`Lux: I'm always watching… always counting.`, "#9a2a5c");
        }, 2000);

    } else if (kills === 250) {
        log(`Lux: 250… your hands are growing heavy with the weight of life.`, "#5c2b9f");
        setTimeout(() => {
            log(`Lux: I wonder… do you even notice who you've become?`, "#b02a4a");
        }, 1200);

    } else if (kills === 500) {
        log(`Lux: 500 souls. Half a millennium of life extinguished by your hand.`, "#6a2d9b");
        setTimeout(() => {
            log(`Lux: And yet, it still feels… insufficient.`, "#c22a3a");
        }, 1000);

    } else if (kills === 750) {
        log(`Lux: 750… your existence is a tapestry of loss.`, "#7a2f96");
        setTimeout(() => {
            log(`Lux: Do you hear them whispering?`, "#d12a2e");
        }, 1000);
        setTimeout(() => {
            log(`Lux: Every soul you took… they still scream.`, "#e22a1f");
        }, 2000);

    } else if (kills === 1000) {
        log(`Lux: 1000 souls… a thousand lives, extinguished.`, "#8a318f");
        setTimeout(() => {
            log(`Lux: Can you feel the weight?`, "#ff3b1a");
        }, 1000);
        setTimeout(() => {
            log(`Lux: I can. And I am immortal.`, "#ff0000");
        }, 2000);

    } else if (kills === 5000) {
        log(`Lux: 5000… the world trembles beneath your deeds.`, "#9b3387");
        setTimeout(() => {
            log(`Lux: So many lives… and yet… I endure.`, "#ff0000");
        }, 1000);
        setTimeout(() => {
            log(`Lux: Mortals like you… fleeting. Me… eternal.`, "#ff0000");
        }, 2000);

    } else if (kills === 10000) {
        log(`Lux: 10,000 souls. I almost admire your persistence.`, "#ad347e");
        setTimeout(() => {
            log(`Lux: Almost.`, "#ff0000");
        }, 1000);
        setTimeout(() => {
            log(`Lux: But I am beyond your comprehension.`, "#ff0000");
        }, 2000);

    } else if (kills === 100000) {
        log(`Lux: 100,000 souls… You have become a harbinger of death itself.`, "#c03672");
        setTimeout(() => {
            log(`Lux: And yet, you are nothing…`, "#ff0000");
        }, 1000);
        setTimeout(() => {
            log(`Lux: I am eternal. I see all.`, "#ff0000");
        }, 2000);
        setTimeout(() => {
            log(`Lux: Every timeline. Every choice. Every failure. Every triumph.`, "#ff0000");
        }, 3000);
        setTimeout(() => {
            log(`Lux: And it all belongs to me.`, "#ff0000");
        }, 4000);
    }
}


    function updateUI() {
    // 1. Player Vital Stats (HP, Mana, Sanity)
    document.getElementById('hp-val').innerText = `${formatNumber(p.hp)}/${formatNumber(p.mhp)}`;
    document.getElementById('hp-bar').style.width = Math.min(100, (p.hp / p.mhp) * 100) + "%";
    document.getElementById('mp-val').innerText = `${formatNumber(p.mp)}/${formatNumber(p.mmp)}`;
    document.getElementById('mp-bar').style.width = Math.min(100, (p.mp / p.mmp) * 100) + "%";
    document.getElementById('sn-val').innerText = `${formatNumber(p.sn)}/${formatNumber(p.msn)}`;
    document.getElementById('sn-bar').style.width = Math.min(100, (p.sn / p.msn) * 100) + "%";
    // 2. LV and EXP Progress Bar
    let nextLevelExp = Math.floor(100 * Math.pow(1.2, p.lv - 1));
    let expPercent = (p.exp / nextLevelExp) * 100;
    document.getElementById('lv-txt').innerText = p.lv;
    document.getElementById('exp-val').innerText = `${formatNumber(p.exp)}/${formatNumber(nextLevelExp)}`;
    document.getElementById('exp-bar').style.width = Math.min(100, expPercent) + "%";
    // 3. Currency and Resources
    document.getElementById('gold-txt').innerText = formatNumber(p.gold);
    document.getElementById('sp-txt').innerText = formatNumber(p.sp);
    document.getElementById('day-txt').innerText = p.day;
    // 3.5. Sidebar
    document.getElementById('side-mhp').innerText = formatNumber(p.mhp);
    document.getElementById('side-hp').innerText  = formatNumber(p.hp);
    document.getElementById('side-mmp').innerText = formatNumber(p.mmp);
    document.getElementById('side-mp').innerText  = formatNumber(p.mp);
    document.getElementById('side-msn').innerText = formatNumber(p.msn);
    document.getElementById('side-sn').innerText  = formatNumber(p.sn);
    document.getElementById('side-lv').innerText = p.lv;
    document.getElementById('side-exp').innerText = formatNumber(p.exp);
    document.getElementById('side-sp').innerText = formatNumber(p.sp);
    document.getElementById('side-gold').innerText = formatNumber(p.gold);
    let expRemaining = nextLevelExp - p.exp;
    document.getElementById('side-next-exp').innerText = formatNumber(expRemaining);
    // Convert manaReduction decimal (0.05) to percentage (5%)
    let redPercent = Math.round((p.manaReduction || 0) * 100);
    document.getElementById('side-red').innerText = redPercent + "%";
    document.getElementById('side-kills').innerText = formatNumber(p.kills);
    // Convert dmgMult decimal (0.05) to percentage (5%)
    let dmgMultPrecent = Math.round(((p.dmgmult || 0) - 1) * 100);
    document.getElementById('side-dmgmult').innerText = dmgMultPrecent + "%";
    // 4. Enemy Stats (Conditional check if in combat)
    if (enemy) {
        // Update Enemy HP Text with shorthand (e.g., 1.2M / 1.5M)
        const eHpTxt = document.getElementById('e-hp-txt');
        if (eHpTxt) eHpTxt.innerText = `HP: ${formatNumber(enemy.hp)} / ${formatNumber(enemy.mhp)}`;

        const eHpBar = document.getElementById('e-hp-bar');
        if (eHpBar) eHpBar.style.width = Math.max(0, Math.min(100, (enemy.hp / enemy.mhp) * 100)) + "%";

        const eTraits = document.getElementById('e-traits');
        if (eTraits) eTraits.innerText = "Specialty: " + enemy.trait;
        
        // Sync name and status
        document.getElementById('e-name').innerText = enemy.name + (enemy.burn > 0 ? " (Burning)" : "");
    }
}

// Listen for the "Enter" key on the console input
document.getElementById('console-input').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        const inputField = e.target;
        const commandText = inputField.value.trim();
        if (commandText) {
            handleCommand(commandText);
            inputField.value = ""; // Clear input
        }
    }
});

window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !document.getElementById('debugging-panel').classList.contains('hidden')) {
        toggleAdmin();
    }
});

function handleCommand(cmd) {
    const args = cmd.split(" ");
    const command = args[0].toLowerCase();
    const val = parseInt(args[1]);
    const output = document.getElementById('console-output');
    let response = "";
    let successColor = "#2ed573";
    switch (command) {
        case '/spawn':
            // args[0] is "/spawn", args.slice(1).join(" ") gets the full enemy name
            let targetName = args.slice(1).join(" ").toLowerCase();
            
            // Search the enemies list for a name match
            let found = enemies.find(e => e.name.toLowerCase() === targetName);
            
            if (found) {
                nextEnemyOverride = found.name; // Store the exact name
                response = `The next entity you encounter will be: ${found.name}`;
            } else {
                response = "Error: Entity not found in master database.";
                successColor = "#ff4757";
            }
            break;
        case '/manared':
            // val is the second word of the command (e.g., 50 in "/manared 50")
            if (!isNaN(val)) { 
                // Clamp the value between 0 and 100, then convert to decimal
                let percentage = Math.max(0, Math.min(100, val));
                p.manaReduction = percentage / 100; 
                response = `Mana efficiency increased. Costs reduced by ${percentage}%`; 
            } else { 
                response = "Error: Use /manared 0-100"; 
                successColor = "#ff4757"; 
            }
            break;
        case '/dmgmult':
            // val is the second word of the command (e.g., 50 in "/dmgmult 50")
            if (!isNaN(val)) { 
                // Clamp the value between 0 and 100, then convert to decimal
                let percentage = Math.max(0, val);
                p.dmgmult = percentage / 100; 
                response = `Mana efficiency increased. Costs reduced by ${percentage}%`; 
            } else {                 
                response = "Error: Use /manared 0-100"; 
                successColor = "#ff4757"; 
            }
        break;
        case '/refillhp':
            p.hp = p.mhp;
            response = "Vitality restored to maximum.";
            break;
        case '/mhp':
            if (!isNaN(val)) { p.mhp = val; p.hp = val; response = `Max HP set to ${val}.`; }
            else { response = "Error: Invalid value."; successColor = "#ff4757"; }
            break;
        case '/refillmp':
            p.mp = p.mmp;
            response = "Mana pool replenished.";
            break;
        case '/mmp':
            if (!isNaN(val)) { p.mmp = val; p.mp = val; response = `Max Mana set to ${val}.`; }
            else { response = "Error: Invalid value."; successColor = "#ff4757"; }
            break;
        case '/refillsanity':
            p.sn = p.msn;
            response = "Mind stabilized to maximum.";
            break;
        case '/msan':
            if (!isNaN(val)) { p.msn = val; p.sn = val; response = `Max Sanity set to ${val}.`; }
            else { response = "Error: Invalid value."; successColor = "#ff4757"; }
            break;
        case '/gold':
            if (!isNaN(val)) { p.gold = val; response = `Treasury adjusted to ${val}g.`; }
            break;
        case '/exp':
            if (!isNaN(val)) { 
                addExperience(val); 
                response = `Granted ${val} EXP. Current LV: ${p.lv}`; 
            } else {
                response = "Error: Use /exp [number]";
                successColor = "#ff4757";
            }
            break;
        case '/help':
            response = "Available: /refillhp, /mhp x, /refillmp, /mmp x, /refillsanity, /msan x, /gold x, /exp x";
            successColor = "var(--mana)";
            break;
        default:
            response = "Unknown command. Type /help for a list of commands.";
            successColor = "#ff4757";
    }

    // Log to console output and main game log
    output.innerHTML += `<div style="color:${successColor}">> ${cmd}<br><span style="color:#aaa">${response}</span></div>`;
    output.scrollTop = output.scrollHeight;
    log(`Console: ${response}`, successColor);
    updateUI();
}

function toggleAdmin() {
    const panel = document.getElementById('debugging-panel');
    panel.classList.toggle('hidden');
    if (!panel.classList.contains('hidden')) {
        document.getElementById('console-input').focus();
    }
}

function formatNumber(num) {
    if (num === Infinity) return "∞";
    if (num === undefined || num === null || isNaN(num)) return "0";
    if (num < 1000 && num > -1000) return Math.ceil(num).toString();
    const units = ["", "k", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc", "Ud", "Dd", "Td", "Qad", "Qid", "Sxd", "Spd", "Ocd", "Nod", "Vg", "Uvg", "Dvg", "Tvg", "Qavg", "Qidvg"];
    const tier = Math.floor(Math.log10(Math.abs(num)) / 3);
    /* CRITICAL SAFETY CHECK: 
     If the tier is higher than your list, return the last unit or Infinity
    */
    if (tier >= units.length) return "∞";
    const suffix = units[tier];
    const scale = Math.pow(10, tier * 3);
    const scaled = num / scale;
    return scaled.toFixed(1).replace(/\.0$/, "") + suffix;
}

    function log(msg, color = "#e1e1e6") {
    const l = document.getElementById('log');
    
    // 1. Create and add the new log message
    const newEntry = document.createElement('div');
    newEntry.style.color = color;
    newEntry.innerHTML = `[Day ${p.day}] ${msg}`;
    l.appendChild(newEntry);

    // 2. CRITICAL: Limit the log to 1,000 messages
    // If we have more than 1000 messages, remove the oldest one (the first child)
    while (l.children.length > 1000) {
        l.removeChild(l.firstChild);
    }

    // 3. Auto-scroll to the bottom
    l.scrollTop = l.scrollHeight;
}

    function nextDay() {
        p.day++;
        let manaLossScalingFactor = p.day;
        let manaRegainedScalingFactor = p.lv;
        if (p.sn > 0) {
            let manaRegained = 100 * manaRegainedScalingFactor;
            p.mp = Math.min(p.mmp, p.mp + manaRegained);
            log(`Resting between days restores mana... (${formatNumber(manaRegained)} Mana Regained)`, "var(--mana)");
            if (Math.random() < 0.05) {
            log(`Lux: Maybe don't be lazy, and maybe, just maybe, you'll get what you want.`, "#3c23a8")
            }
        } else {
            let manaLost = 50 * manaLossScalingFactor;
            p.mp = Math.max(0, p.mp - manaLost);
            log(`Lux consumes your essence... (${formatNumber(manaLost)} Mana Lost)`, "var(--sanity)");
            if (Math.random() < 0.05) {
                log(`Lux: Maybe don't be insane, and maybe we wouldn't be in this situation.`,"#3c23a8")
            }
        }
        
        let roll = Math.random();
        // 15% Spring, 25% Shop, 60% Combat
        if (roll < 0.15) {
            let springScalingRestore = 50*p.lv
            log(`You discovered a Tranquil Spring. (All Stats recovered by ${formatNumber(springScalingRestore)})...`, "#00ffff");
            if (Math.random() < 0.05) {
                log (`Lux: Do you really think a little pond will help you?`,"#3c23a8")
            }
            p.hp = Math.min(p.mhp, p.hp + springScalingRestore); 
            p.mp = Math.min(p.mmp, p.mp + springScalingRestore); 
            p.sn = Math.min(p.msn, p.sn + springScalingRestore);
            updateUI();
        } else if (roll < 0.40) startShop();
        else startCombat();
    }

    function startShop() {
    if (Math.random() < 0.05) {
        log(`Lux: Oh look, a wandering merchant. Better stock up on goods =)`,"#3c23a8")
    }
    log("The Wandering Merchant beckons you...", "var(--gold)");
    document.getElementById('main-controls').classList.add('hidden');
    document.getElementById('shop-view').classList.remove('hidden');
    const shelf = document.getElementById('shop-shelf'); 
    shelf.innerHTML = "";
    
    // FILTER: Remove the stabilizer if manaReduction is 100% (1)
    let availableItems = masterShop.filter(item => {
        if (item.id === 'manastabilizer' && p.manaReduction >= 1) return false;
        return true;
    });

    // Pick 3 random items from the filtered list
    let items = [...availableItems].sort(() => 0.5 - Math.random()).slice(0, 3);
    
    items.forEach((item, index) => {
        let div = document.createElement('div');
        div.className = "shop-item";
        div.innerHTML = `
            <strong>${item.name}</strong><br>
            ${formatNumber(item.cost)}g<br>
            <button id="shop-btn-${index}" style="margin-top:10px" 
                onclick="buyItem('${item.id}', 'shop-btn-${index}')">Acquire</button>`;
        shelf.appendChild(div);
    });
}

function maybeSoldOut(btn) {
    btn.innerText = Math.random() < 0.05 ? "=)" : "Sold Out";
}

function buyItem(id, btnId) {
    let item = masterShop.find(i => i.id === id);
    if (p.gold >= item.cost) { 
        p.gold -= item.cost; 
        log(item.run(), "var(--unlocked)"); 
        
        let btn = document.getElementById(btnId);
        if (btn) {
            btn.disabled = true;

            // 5% chance to show "=)" instead of "Sold Out"
            btn.innerText = Math.random() < 0.05 ? "=)" : "Sold Out";
        }

        // FIX: Force combat buttons to re-render if the combat view is visible
        const combatView = document.getElementById('combat-view');
        if (combatView && !combatView.classList.contains('hidden')) {
            renderCombatButtons();
        }

        updateUI(); 
    } else {
    if (Math.random() < 0.05) {
        log(`Lux: You're broke, you know that? Or are you blind as hell? Actually, I don't care if you're blind or not. Just makes it either faster or slower to kill you later.`,"#3c23a8")
    }
        log("You lack the coin. This world is not for the poor...", "#ff4757");
    }
}

    function positionTooltip(e, tip) {
    let x = e.clientX + 15;
    let y = e.clientY + 15;

    // Wait for the next frame to get the tooltip's actual width/height
    const tipWidth = tip.offsetWidth;
    const tipHeight = tip.offsetHeight;
    const winWidth = window.innerWidth;
    const winHeight = window.innerHeight;

    // Check right edge
    if (x + tipWidth > winWidth) {
        x = e.clientX - tipWidth - 15;
    }

    // Check bottom edge
    if (y + tipHeight > winHeight) {
        y = e.clientY - tipHeight - 15;
    }

    // Ensure it doesn't go off the left or top (safety)
    x = Math.max(5, x);
    y = Math.max(5, y);

    tip.style.left = x + 'px';
    tip.style.top = y + 'px';
}

function renderCombatButtons() {
    const zone = document.getElementById('combat-btns');
    const searchInput = document.getElementById('action-search');
    const query = searchInput ? searchInput.value.toLowerCase() : ""; 
    
    if (!zone) return; 
    zone.innerHTML = ""; 

    const categories = [
        { label: "Basic Actions", filter: (s) => !s.mp || s.name === "Strike" },
        { label: "Damaging Spells", filter: (s) => s.dmg },
        { label: "Healing Spells", filter: (s) => (s.heal || s.san) && s.mp && s.name !== "Snowgrave"},
    ];

    categories.forEach(cat => {
        const matchingSkills = p.skills.filter(sid => {
            let s = skillTree[sid];
            return s && cat.filter(s) && s.name.toLowerCase().includes(query);
        });

        if (matchingSkills.length > 0) {
            const header = document.createElement('div');
            header.style = "grid-column: span 2; color: #a4b0be; font-size: 0.75em; margin-top: 10px; border-bottom: 1px solid #2f3542; text-transform: uppercase;";
            header.innerText = cat.label;
            zone.appendChild(header);

            matchingSkills.forEach(sid => {
                let s = skillTree[sid];
                let b = document.createElement('button');
                let currentCost = getScaledMana(s.mp || 0);
                
                b.innerText = `${s.name}${s.mp ? ' (' + formatNumber(currentCost) + ' MP)' : ''}`;
                b.onclick = () => cast(sid);

                b.onmouseenter = (e) => {
                    const tip = document.getElementById('tooltip');
                    let html = `<strong>${s.name}</strong><br>`;
                    if (s.dmg) html += `DMG: <span style="color:var(--hp)">${formatNumber(s.dmg)}</span><br>`;
                    if (s.heal) html += `Healing: <span style="color:var(--unlocked)">${formatNumber(s.heal)}</span><br>`;
                    if (s.san) html += `Sanity: <span style="color:var(--sanity)">${formatNumber(s.san)}</span><br>`;
                    if (s.burn) html += `Burn: <span style="color:var(--gold)">${s.burn} turns</span><br>`;
                    
                    tip.innerHTML = html + `<hr style="border:0;border-top:1px solid #444;margin:5px 0"><small>${s.mp ? 'Cost: ' + formatNumber(currentCost) + ' MP' : 'No Cost'}</small>`;
                    tip.style.display = 'block';
                    
                    let x = e.clientX + 15;
                    let y = e.clientY + 15;
                    if (x + 200 > window.innerWidth) x = e.clientX - 215;
                    if (y + tip.offsetHeight > window.innerHeight) y = window.innerHeight - tip.offsetHeight - 10;
                    
                    tip.style.left = x + 'px';
                    tip.style.top = y + 'px';
                };

                b.onmousemove = (e) => {
                    const tip = document.getElementById('tooltip');
                    let x = e.clientX + 15;
                    let y = e.clientY + 15;
                    if (x + 200 > window.innerWidth) x = e.clientX - 215;
                    if (y + tip.offsetHeight > window.innerHeight) y = window.innerHeight - tip.offsetHeight - 10;
                    tip.style.left = x + 'px';
                    tip.style.top = y + 'px';
                };

                b.onmouseleave = () => {
                    document.getElementById('tooltip').style.display = 'none';
                };

                zone.appendChild(b);
            });
        }
    });

    if (zone.innerHTML === "" && query !== "") {
        zone.innerHTML = `<div style="grid-column: span 2; text-align: center; color: #666; margin-top: 10px;">No actions matching "${query}"</div>`;
    }
}


function openTree() {
    document.getElementById('main-controls').classList.add('hidden');
    document.getElementById('tree-view').classList.remove('hidden');
    renderTree();
}
function renderTree() {
    const container = document.getElementById('tree-nodes'); 
    container.innerHTML = "";
    for (let id in skillTree) {
        let s = skillTree[id];
        let isParentUnlocked = !s.parent || skillTree[s.parent].unlocked;
        let div = document.createElement('div');
        div.className = `node ${s.unlocked ? 'purchased' : (isParentUnlocked ? 'available' : '')}`;
        
        // 5% chance to replace name and cost with "=)"
        let displayName = Math.random() < 0.05 ? "=)" : s.name;
        let displayCost = Math.random() < 0.05 ? "=)" : (s.unlocked ? 'Known' : s.cost + ' SP');

        div.innerHTML = `<strong>${displayName}</strong><br>${displayCost}`;

        if (isParentUnlocked && !s.unlocked) div.onclick = () => buySkill(id);
        container.appendChild(div);
    }
}


function buySkill(id) {
    let s = skillTree[id];
    if (s.unlocked) return;

    // UPDATED: Check against the spell's specific cost instead of a fixed 1
    if (p.sp >= s.cost) { 
        p.sp -= s.cost; // Deduct the correct amount
        s.unlocked = true;
        p.skills.push(id);
        log(`Learned ${s.name}!`, "var(--unlocked)");
        if (Math.random() < 0.05) {
            log(`Lux: Congratulations. You got a new spell. Doesn't really help you anyway. I can still delete you =)`,"#3c23a8")
        }
        renderTree();
        updateUI();
    } else {
        // Updated log message to show required points
        log(`You need ${s.cost} Skill Points to learn this.`, "#ff4757");
        if (Math.random() < 0.05) {
            log(`Lux: You lack the wizdom that I have. I'm still a god in this world anywy. You're nothing...`,"#3c23a8")
        }
    }
}


    function getScaledMana(baseCost) {
        // If baseCost is undefined (like Strike), return 0 immediately, otherwise code will break
        if (baseCost === undefined || baseCost === null || baseCost === 0) return 0;
        
        let multiplier = p.mmp / 100;
        let scaledCost = baseCost * multiplier;
        
        // Use '|| 0' to handle cases where manaReduction might be missing, so code doesn't break
        let reductionAmount = scaledCost * (p.manaReduction || 0);
        
        let finalCost = Math.max(baseCost, scaledCost - reductionAmount);
        return Math.floor(finalCost);
    }
    function startCombat() {
    let selectedEnemy = null;

    // Lux Override Check.
    // If a random chance happens, replace enemy
    if (nextEnemyOverride) {
        selectedEnemy = enemies.find(e => e.name.toLowerCase() === nextEnemyOverride.toLowerCase());
        nextEnemyOverride = null; 
        if (selectedEnemy) log("You have encountered an unnatural enemy. Maybe Lux sent them?", "#3c23a8");
    }

    // 2. STANDARD SELECTION (If no override exists)
    if (!selectedEnemy) {
        // Filter the pool based on LV and Skills
        let eligiblePool = enemies.filter(e => {
            try {
                return e.canSpawn ? e.canSpawn() : true;
            } catch(err) {
                return true; 
            }
        });

        // Fallback if the pool is empty
        if (eligiblePool.length === 0) {
            eligiblePool = [enemies.find(e => e.name === "Shadow Imp") || enemies[0]];
        }

        // Calculate Weights
        let totalWeight = 0;
        eligiblePool.forEach(e => {
            totalWeight += (e.weight || 10);
        });

        // Weighted Roll
        let roll = Math.random() * totalWeight;
        for (let i = 0; i < eligiblePool.length; i++) {
            roll -= (eligiblePool[i].weight || 10);
            if (roll <= 0) {
                selectedEnemy = eligiblePool[i];
                break;
            }
        }
        
        // Final safety fallback
        if (!selectedEnemy) selectedEnemy = eligiblePool[0];
    }

    // 3. INITIALIZE THE ENCOUNTER
    // Clone the template so we don't modify the master 'enemies' array
    enemy = { ...selectedEnemy, burn: 0 };

    // 4. UI TRANSITIONS
    document.getElementById('main-controls').classList.add('hidden');
    document.getElementById('combat-view').classList.remove('hidden');
    
    renderCombatButtons(); 
    updateUI(); 
    
    log(`Engaged in combat with: ${enemy.name}`, "#ff4757");

    // 5. SPECIAL DIALOGUE CHECK
    if (selectedEnemy.specialMsg) {
        setTimeout(() => {
            log(selectedEnemy.specialMsg, "#bf2c89");
        }, 150);
    }
}


    function cast(sid) {
        let s = skillTree[sid];
        let scaledCost = getScaledMana(s.mp);

        if (s.mp && p.mp < scaledCost) {
            log(`Insufficient Mana! Need ${scaledCost} MP.`, "#ff4757");
            if (Math.random() < 0.2) {
            log(`Lux: You absolute baffoon. You're stressing yourself out more and more. Do you really want to burn out your soul? It'll just make it more crispy when I eat it later =)`, "#3c23a8");
            }
            return; 
        }

        if (s.mp) p.mp -= scaledCost;

        if (s.dmg) { 
            enemy.hp -= s.dmg; 
            log(`You strike with ${s.name} for ${s.dmg} damage.`); 
            if (Math.random() < 0.05) {
                log(`Lux: You dealt ${s.dmg} damage. Nice job. Just don't forget...`,"#3c23a8")
                log(`Lux: I can do much, much more.`,"#ff0000")
            }
        }

        if (s.burn) {
            if (enemy.burnImmune) {
                log(`${enemy.name} is immune to burn!`, "var(--gold)");
            } else {
                enemy.burn = s.burn;  // Still apply duration normally
                log(`${enemy.name} is set ablaze for ${s.burn} turns!`, "var(--gold)");
            }
        }
        if (s.heal) p.hp = Math.min(p.mhp, (p.hp || 0) + s.heal);
        if (s.san) p.sn = Math.min(p.msn, (p.sn || 0) + s.san);

        if (p.sn > 0) p.mp = Math.min(p.mmp, p.mp + 5);

        if (enemy.hp <= 0) win(); else enemyTurn();
        updateUI();
    }
    function enemyTurn() {
        // Burn tick (before enemy attacks)
        if (enemy.burn > 0) {
           if (enemy.burnImmune) {
                // Shouldn't reach here if immune, but safety
                enemy.burn = 0;
            } else {
                let baseBurnDMG = Math.floor(p.lv * 2);

                // Apply resist/vuln multipliers
                let multiplier = 1;
                if (enemy.burnResist !== undefined) multiplier *= enemy.burnResist;
                if (enemy.burnVuln !== undefined) multiplier *= enemy.burnVuln;
            
                let finalBurnDMG = Math.floor(baseBurnDMG * multiplier);

                enemy.hp -= finalBurnDMG;
                enemy.burn--;

                log(`${enemy.name} is burning! (-${finalBurnDMG} HP)`, "var(--gold)");

                // Optional: Reflect
                if (enemy.burnReflect !== undefined && enemy.burnReflect > 0) {
                    let reflectDMG = Math.floor(finalBurnDMG * enemy.burnReflect);
                    p.hp -= reflectDMG;
                    log(`${enemy.name} reflects ${reflectDMG} burn damage back to you!`, "var(--hp)");
                }
            }
        }


        if (enemy.hp <= 0) return win();
        if (enemy.lifesteal > 0) {
            enemy.hp = Math.min(enemy.mhp, enemy.hp + enemy.lifesteal);
            log(`${enemy.name} drains your life and heals ${enemy.lifesteal} HP`, "var(--hp)");
        }
        p.hp -= enemy.atk;
        if (enemy.san > 0) {
            p.sn = Math.max(0, p.sn - enemy.san);
            log(`${enemy.name} strikes for ${enemy.atk} HP and <span class="san-warn">${enemy.san} Sanity Drain</span>!`);
        } else log(`${enemy.name} strikes for ${enemy.atk} HP.`);
        if (p.hp <= 0) { 
            log(`Enjoy the bitter-sweet, cold, embrace of death =)`,"#3c23a8")
            log("You have perished.", "#ff4757"); document.body.style.pointerEvents = "none"; 
        }
    }
function addExperience(amt) {
    // 1. Handle the addition/subtraction
    // Math.max(0, ...) ensures your EXP never becomes a negative number
    p.exp = Math.max(0, p.exp + amt);

    // 2. Log the result
    if (amt >= 0) {
        log(`Gained ${formatNumber(amt)} EXP.`, "lime");
    } else {
        log(`Lux, the ever immortal god, consumes your knowledge... (${formatNumber(amt)} EXP)`, "var(--sanity)");
    }

    // 3. Level-Up Logic (Only runs if we have enough EXP to level up)
    let nextLevelExp = Math.floor(100 * Math.pow(1.2, p.lv - 1));
    let loopCount = 0; // Safety to prevent browser freeze

    while (p.exp >= nextLevelExp) {
        p.exp -= nextLevelExp;
        p.lv++;
        p.sp++; 

        // 1.1x Stat Growth Formula: floor(CurrentMax * 1.1)
        // We calculate the gain (10%) and ensure it's at least 1
        let hpGain = Math.max(1, Math.floor(p.mhp * 0.1));
        let mpGain = Math.max(1, Math.floor(p.mmp * 0.1));
        let snGain = Math.max(1, Math.floor(p.msn * 0.1));

        p.mhp += hpGain;
        p.mmp += mpGain;
        p.msn += snGain;

        // Full Refill on Level Up
        p.hp = p.mhp;
        p.mp = p.mmp;
        p.sn = p.msn;
        
        log(`LEVEL UP! Reached LV ${p.lv}. Stats increased! (+${formatNumber(hpGain)} Max HP, +${formatNumber(mpGain)} Max Mana, +${formatNumber(snGain)} Max Sanity)`, "var(--unlocked)");
        if (Math.random() < 0.05) {
            log(`Lux: Oh hey. Another LV. You do know what LV stands for... right? Just so you know, my LV is beyond mortal limits.`,"#3c23a8")
        }

        // Recalculate requirement for the next level in the loop
        nextLevelExp = Math.floor(100 * Math.pow(1.2, p.lv - 1));

        // 4. Safety Break
        // If a player gains enough EXP to level up >1000 times at once, 
        // we stop the loop to prevent the game from freezing.
        loopCount++;
        if (loopCount > 1000) {
            log("Experience surge stabilized at current level.", "var(--gold)");
            log("Lux: If only. Oh if only you could. Sadly, everything must have limits. Except me of course.", "#3c23a8");
            break;
        }
    }

    // 5. Final UI Sync
    updateUI();
}


// Update win function to use the new experience helper
    function win() {
    log(`Victory! Looted ${formatNumber(enemy.gold)}g and ${formatNumber(enemy.exp)} EXP.`, "var(--unlocked)");
    if (Math.random() < 0.05) {
        log(`Lux: Congratulations. Yet another soul you've removed off my realm. Thanks for doing my job for me =)`,"#3c23a8")
    }
    
    // Safety check: Don't let gold drop below 0
    p.gold = Math.max(0, p.gold + enemy.gold);
    
    addExperience(enemy.exp); 
    p.kills += 1;
    enemy = null;
    exitEvent();
    updateUI();
    checkLuxKillLogs();
}


    function exitEvent() {
        document.getElementById('shop-view').classList.add('hidden');
        document.getElementById('tree-view').classList.add('hidden');
        document.getElementById('combat-view').classList.add('hidden');
        document.getElementById('main-controls').classList.remove('hidden');
        updateUI();
    }
    /* ADMIN FUNCTIONS */
    function toggleAdmin() {
        document.getElementById('debugging-panel').classList.toggle('hidden');
    }
    function adminRefill(t) {
        if(t==='hp') p.hp=p.mhp; if(t==='mp') p.mp=p.mmp; if(t==='sn') p.sn=p.msn;
        log(`Admin: Refilled ${t.toUpperCase()}`, "var(--mana)"); updateUI();
    }
    function adminSet(s) {
        let v = parseInt(prompt(`New ${s.toUpperCase()}:`, p[s]));
        if(!isNaN(v)) { p[s]=v; if(s.startsWith('m')) p[s.substring(1)]=Math.min(p[s.substring(1)],v); updateUI(); }
    }
    // Function to export your current game state as a .urpg file
    function exportSave() {
        const saveData = JSON.stringify(p, (key, value) => 
            value === Infinity ? "Infinity" : value
        );
        const blob = new Blob([saveData], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `luxs_rpg_save.urpg`;
        if (Math.random() < 0.05) {
            link.download = `luxs_world_not_yours.urpg`;
        } else if (Math.random() >= 0.25) {
            link.download = `luxs_rpg_save.urpg`;
        }
        link.click();
        URL.revokeObjectURL(url);
        log("Save file exported", "var(--gold)");
        if (Math.random() < 0.05) {
            log(`Lux: You may have escaped this timeline, but I exist in each timeline. No matter where you go, I'm still here =)`,"#ff0000")
        }
    }
    
    // Function to read a .urpg file and overwrite the game state
function importSave(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const loadedData = JSON.parse(e.target.result, (key, value) => 
                value === "Infinity" ? Infinity : value
            );

            // CRITICAL: Block any file that doesn't have version 8
            if (!loadedData.v || loadedData.v < 8) {
                log("Error: Legacy save files are not compatible.", "#ff4757");
                if (Math.random() < 0.05) {
                    log(`Lux: You thought you could turn back time to when I didn't exist. Think. Again. Mortal.`,"#ff0000")
                }
                // Reset the file input so the user can try again
                event.target.value = ""; 
                return;
            }

            // If it passes the check, proceed with the import
            p = loadedData;

            // Sync skill tree "unlocked" states
            for (let id in skillTree) {
                skillTree[id].unlocked = (id === 'strike'); 
            }
            p.skills.forEach(skillId => {
                if (skillTree[skillId]) skillTree[skillId].unlocked = true;
            });

            updateUI();
            log(`Save loaded! Welcome back to day ${p.day}, LV ${p.lv}.`, "var(--unlocked)");
            if (Math.random() < 0.05) {
                log(`Lux: Oh hello again! Long time no see huh? Or is it just because I'm immortal, time flows... differently... for me?`,"#00ff00")
            }
        } catch (err) {
            log("Error: This file is either corrupted or not a valid .urpg file.", "#ff4757");
            if (Math.random() < 0.1) {
                log(`Lux: Did you really think you could edit this world like files?`,"#ff0000")
            }
        }
    };
    reader.readAsText(file);
}
</script>
</body>
</html>